/* © Clarify Cloud Limited 2013, 2014
All Rights Reserved
No part of this material or any of its contents may be reproduced, copied, modified or adapted, without prior written consent from Clarify Cloud Limited.
*/
document.addEventListener("deviceready",onReady,false);var popupDialog=$("#popupDialog");var popupReview=$("#popupReview");function onReady(){var a=null;var b=null;if(device){var a=device.model;var b=device.uuid}if(b===null){b=navigator.appName;statusItem.blockUUID=b}else{statusItem.blockUUID=b}txData.connectionState()}var tableCheck=null;var intervalTableCheck=3000;var nameregister=$("#nameregister");var emailregister=$("#emailregister");var passwordregister1=$("#passwordregister1");var passwordregister2=$("#passwordregister2");var tcregister=$("#tcregister");$(document).delegate("#results","pageshow",function(){if(tableCheck){clearInterval(tableCheck);tableCheck=null}tableCheck=setInterval(function(){txData.displayLocalStorage();if(statusItem.pieceFinishedDataSend==true){statusItem.pieceFinishedDataSend=false;$("#popupDialog").popup();$("#popupDialog").popup("open")}},intervalTableCheck)});$(document).delegate("#results","pagehide",function(){if(tableCheck){clearInterval(tableCheck);tableCheck=null}});$("#tcconditions").on("click",function(b){b.stopPropagation();b.preventDefault();var a=statusItem.baseURL+"/TermAndCondition.html";var c=txData.connectionState();if(c){$("#tcdisplay").popup();$("#tcdisplay").popup("open",{x:20,y:20});$("#tcdisplayframe").attr("src",a).attr("height","500px").attr("width","600px")}else{OfflineMessage()}});$("#btntoregister").on("click",function(a){a.stopPropagation();a.preventDefault();goToResisterPage()});$("#regbenefits").on("click",function(a){a.stopPropagation();a.preventDefault();goToResisterPage()});$("#initialprofile").on("click",function(a){a.stopPropagation();a.preventDefault();goToResisterPage()});$("#constraintdemo").on("click",function(a){a.stopPropagation();a.preventDefault();goToResisterPage()});$("#constrainupdate").on("click",function(){if(navigator.notification){navigator.notification.alert("To Upgrade Subscription go to\n rowcatcher.com",a,"Notice","Ok")}else{alert("To Upgrade Subscription go to\n rowcatcher.com")}function a(){}});function goToResisterPage(){var a=txData.connectionState();if(a){$.mobile.changePage("#shortregisterpage",{transition:"slideup",reverse:true,changeHash:true})}else{OfflineMessage()}}$("#submitregister").on("click",function(b){b.stopPropagation();b.preventDefault();var d=txData.connectionState();if(!d){OfflineMessage()}else{var a=tcregister.is(":checked");var c=validateEmail(emailregister.val());if(nameregister.val()==""){alertMsg("Name Cant Be Blank")}else{if(emailregister.val()==""){alertMsg("E-Mail Cant Be Blank")}else{if(!c){alertMsg("E-Mail Format Incorrect\n name@domain.com")}else{if(passwordregister1.val()==""){alertMsg("Password Cant Be Blank")}else{if(passwordregister2.val()==""){alertMsg("Confirm password Cant Be Blank")}else{if(passwordregister1.val()!=passwordregister2.val()){alertMsg("Confirm Password is not the same")}else{if(!a){alertMsg("Please Accept Terms and Conditions to proceed")}else{var d=txData.connectionState();if(d){sendRegistrationDetails()}else{OfflineMessage()}}}}}}}}}});$("#cancelregister").on("click",function(a){a.stopPropagation();a.preventDefault();clearTCForm();$.mobile.changePage("#startpage",{transition:"slideup",reverse:true,changeHash:true})});function OfflineMessage(){if(navigator.notification){navigator.notification.alert("Please Try again later",a,"Offline","Ok")}else{alert("Please Try again later")}function a(){}}function alertMsg(b){if(navigator.notification){navigator.notification.alert(b,a,"Notice","Ok")}else{alert(b)}function a(){}}function clearTCForm(){nameregister.val("");emailregister.val("");passwordregister1.val("");passwordregister2.val("");tcregister.prop("checked",false).checkboxradio("refresh")}function validateEmail(a){var b=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;if(!b.test(a)){return false}else{return true}}function sendRegistrationDetails(){var b={Name:nameregister.val(),Email:emailregister.val().toLowerCase(),Password:passwordregister1.val(),TandCAgreeded:true};var a=statusItem.baseURL+"/ShortRegisterScript";$.ajax({type:"POST",url:a,data:b,dataType:"json",success:c}).fail(function(){alertMsg("Try again Later")}).done(function(){});function c(d){if(d.msg=="Success"){alertMsg("To Proceed please check your email\nand follow the instructions");b=null;clearTCForm();$.mobile.changePage("#startpage",{transition:"none",reverse:true,changeHash:true})}else{alertMsg(d.msg)}}}var txData={maxLength:500,connectionState:function(){var a;if(navigator.connection){a=navigator.connection.type;var b={};b[Connection.UNKNOWN]="Unknown connection";b[Connection.ETHERNET]="Ethernet connection";b[Connection.WIFI]="WiFi connection";b[Connection.CELL_2G]="Cell 2G connection";b[Connection.CELL_3G]="Cell 3G connection";b[Connection.CELL_4G]="Cell 4G connection";b[Connection.CELL]="Cell generic connection";b[Connection.NONE]="No network connection";stateConnection=b[a]!="No network connection";if(b[a]=="No network connection"){stateConnection=false}else{stateConnection=true}}else{stateConnection=true}return stateConnection},syncToWeb:function(){var a=txData.checkForStatus();for(var b=0;b<a.length;b++){if(a[b].Save!==true){txData.sendOfflineData(a[b].keyToSend)}else{}}},syncFromWeb:function(f){var a={};var b=new Date();var d=b.getDate();var g=b.getMonth();g+=1;var c=d+"/"+g;a.Today=c;a.Data=f;var e=a;$.jStorage.set("DownLoadData",e)},dataArray:rdLog.returnDataLogArray(),generateUUID:function(){var b="",a,c;for(a=0;a<32;a++){c=Math.random()*16|0;if(a==8||a==12||a==16||a==20){b+="-"}b+=(a==12?4:(a==16?(c&3|8):c)).toString(16)}return b},convertToJsonObj:function(a){var b={guiE:a.guiEvent,guiT:a.guiEventTime,logT:a.logTime,usID:a.userID,usEM:a.userEM,plID:a.trainingPlanID,seID:a.sessionID,piID:a.pieceID,type:a.type,idX:a.idX,paID:a.paID,stRt:a.strokeRate,stCt:a.strokeCount,htRt:a.heartRate,dist:a.distance,spd:a.speed,lat:a.lat,lon:a.lon,acc:a.accuracy,head:a.heading,upLoadID:a.upLoadId};return b},initialTxData:function(a,b){var d=0;var c=0;var e=[];while(d<a.length&&c<=txData.maxLength){if((a[d].upLoadId=="resend")||(typeof a[d].upLoadId=="undefined")){a[d].upLoadId=b;e.push(txData.convertToJsonObj(a[d]));c++}d++}return e},blocksToResend:function(b){var c=[];dataToCheck=$.jStorage.get(b);for(var a=0;a<dataToCheck.savingStatus.length;a++){if(dataToCheck.savingStatus[a].sendingState===false){c.push(dataToCheck.savingStatus[a].blockUUID)}}return c},failedTxData:function(d,a){var c=[];dataToSend=$.jStorage.get(d);for(var b=0;b<dataToSend.rowDataArray.length;b++){if(dataToSend.rowDataArray[b].upLoadId==a){c.push(txData.convertToJsonObj(dataToSend.rowDataArray[b]))}}return c},repeatTxDataOld:function(e,a){var c=0;var b=0;var d=[];while(c<e.length&&b<=txData.maxLength){if((e[c].upLoadId=="resend")||(e[c].upLoadId===null)){e[c].upLoadId=a;d.push(txData.convertToJsonObj(e[c]));b++}c++}return d},resendRepeatData:function(e,d,c){var f=txData.connectionState();var a;if(f=="online"){a=txData.repeatTxDataOLD(e,c);while(a.length!==0){txData.txToMongoDB(e,a,statusItem.blockUUID,d);a=txdata.repeatTxDataOLD(e)}}else{}var b=setTimeout(function(){txData.checkSendingStatus(d);var g=lastPieceData;$.jStorage.set(d,g)},2000)},sendOfflineData:function(c){var b=$.jStorage.get(c);var g=[];var e=[];g=b.rowDataArray;var d=b.athleteId;$.each(g,function(h,i){g[h].upLoadId="resend"});var a=[];var f={rowDataArray:g,savingStatus:e,savedToWeb:false,athleteId:d};$.jStorage.set(c,f);sendToMongoDB(c)},repeatSendToWeb:function(d){var e=false;var a=$.jStorage.get(d);Block=txData.blocksToResend(d);if(Block.length>=1){for(var c=0;c<Block.length;c++){blockData=txData.failedTxData(d,Block[c]);txData.txToMongoDB(a,blockData,Block[c],d);var b=setTimeout(function(){newPieceData=txData.checkSendingStatus(d);$.jStorage.set(d,newPieceData)},2000)}e=false}else{e=true}return e},setSavingStatus:function(a,b,c){var d={};d.blockUUID=b;d.sendingState=c;d.attempts=0;d.dataLastSent=new Date();a.push(d)},upDateSavingStatus:function(d,b,c){var a=$.jStorage.get(d);$.each(a.savingStatus,function(e,f){if(f.blockUUID==b){f.sendingState=c;f.attempts=this.attempts+1;f.dataLastSent=new Date()}});$.jStorage.set(d,a);return a},checkSendingStatus:function(d){var c;if(d!==null){c=$.jStorage.get(d);if(c.savingStatus){var b=c.savingStatus;c.savedToWeb=false;for(var a=0;a<b.length;a++){if(b[a].sendingState===false){c.savedToWeb=false;break}if(a==b.length-1){c.savedToWeb=true}}}}return c},checkUserStatus:function(d){var c;if(d!==null){c=$.jStorage.get(d);if(c.savingStatus){var b=c.savingStatus;c.savedToWeb=false;for(var a=0;a<b.length;a++){if(b[a].sendingState===false){c.savedToWeb=false;break}if(a==b.length-1){c.savedToWeb=true}}}}return c},checkForStatus:function(){var b=$.jStorage.index();var c=new Array();var a=new Array();$.map(b,function(e,d){if(e.match("%")){c.push(e)}return c});$.each(c,function(d,i){var k=i.indexOf("%")+1;var h=i.indexOf("Â£");if(k!==0){var g=$.jStorage.get(i);var e=g.savedToWeb;var j=i.substring(k,h);var f=i;a.push({name:d,value:j,keyToSend:f,Save:e})}});return a},deleteOldEntries:function(){var e=rData.getUserID();var c=$.jStorage.index();var a=new Array();var f=new Array();var d=$.map(c,function(h,g){if(h.match("%")){a.push(h)}return a});var b=$.map(a,function(i,g){var j=$.jStorage.get(i);var h=j.athleteId;if(h==e){f.push(i)}return f});$.each(f,function(l,o){var j=o;var h=o.indexOf("%")+1;var k=o.indexOf("Â£");var m=parseInt(statusItem.daysToKeep);if(h!==0){var q=$.jStorage.get(o);var i=o.substring(h,k);var g=new Date(i);var n=new Date();n.setDate(n.getDate()-m);var p=n-g;if(p<0){}else{$.jStorage.deleteKey(j);$.jStorage.reInit()}}})},findUniquePaIDs:function(a){if(a.length>0){if(!!a[0].nodeType){return _old.apply(this.arguments)}else{return $.grep(a,function(c,b){return $.inArray(c,a)===b})}}else{return""}},askForAggregation:function(g){var d=$.jStorage.get(g);var c=d.athleteId;var e=[];$.map(d.rowDataArray,function(h){if(h.paID!==0){e.push(h.paID)}});var a=txData.findUniquePaIDs(e);var b=statusItem.baseURL+"/KickOffAggOnAtlPaid/?id="+c+"&paid="+a;$.ajax({url:b,success:f}).fail(function(h,i){}).done(function(){popupDialog.popup();popupDialog.popup("close")});function f(){}},displayResultsFromWeb:function(c){var e=$.jStorage.get(c);var i=e.athleteId;var a=[];$.map(e.rowDataArray,function(j){if(j.paID!==0){a.push(j.paID)}});var g=txData.findUniquePaIDs(a);var d=statusItem.baseURL+"/PieceDetailChartMob.html?athID="+i+"&paID="+g;var b=statusItem.baseURL+"/pdc/?id="+i+"&paid="+g;rData.setUrlWebResult(d);rData.setUrlResult(b);$.ajax({url:b,success:f}).fail(function(){}).done(function(){$("#loading-msgreview").hide();$.mobile.hidePageLoadingMsg()});function h(){}function f(l){$("#graphresult").empty();if(l.length>0){var t=new Array();var s=new Array();var q=new Array();var o=new Array();var n=new Array();var m=new Array();var r=$.map(l,function(y,w){var x=new Date(y.logT);o=[x,10*y.stRt];if(y.spd>=0){n=[x,100*y.spd]}else{n=[x,0]}if(y.htRt>1){m=[x,5*y.htRt]}else{m=[x,0]}t.push(o);s.push(n);q.push(m)});var j=[t,s,q];var v={colors:["#f7f32e","#0A820A","#f90909"],grid:{show:true,labelMargin:0,backgroundColor:{colors:["#58FAF4","#7A7A7A"]}},xaxis:{show:false},yaxis:{show:false}};if(navigator.notification){navigator.notification.alert("For a more detailed Chart. Please visit rowcatcher.com",h,"Information","Ok")}else{alert("For a more detailed Chart. Please visit rowcatcher.com")}var u=$.plot($("#graphresult"),j,v);var k=u.getCanvas();var p=k.toDataURL("image/png");rData.setUrlResult(p)}else{if(navigator.notification){navigator.notification.alert("Processing Results",h,"Please Wait","Ok")}else{alert("Processing Results")}popupReview.popup();popupReview.popup("close")}}popupReview.popup();popupReview.popup("open");popupReview.css({top:"20px",left:"30px",display:"block"})},displayLocalStorage:function(){$("#storageList").empty();var a=rData.getUserID();var k=$.jStorage.index();$("#dialogMessage").html("<h1></h1>");var d;d=new Array();var e,c;e=new Array();c=new Array();var f;f=new Array();var g=0;var j=$.map(k,function(m,l){if(m.match("%")){e.push(m)}return e});var h=$.map(e,function(q,l){var o=$.jStorage.get(q);var p=o.athleteId;var n="userid"+rData.getUserEM();var m=$.jStorage.get(n);if(m){if(p==a){c.push(q)}}return c});$.each(c,function(m,p){var o=p;var s=p.indexOf("%")+1;var l=p.indexOf("Â£");if(s!==0){var r=$.jStorage.get(p);var n=r.savedToWeb;var q=p.substring(s,l);d.push({name:m,value:q,Save:n,id:o})}});var b=$.map(e,function(o,m){var p=$.jStorage.get(o);var l=rData.getUserID();var n=p.savedToWeb;if(n){f.push({name:m})}return f});$("#localStorageTmpl").tmpl(d).appendTo("#storageList");$(".ToReview").on("click",function(){var m=txData.connectionState();if(m){$.mobile.showPageLoadingMsg("b","Loading ...");popupReview.popup();popupReview.popup("open",{x:0,y:50});var n=$(this).index(".ToReview");txData.displayResultsFromWeb(d[n].id);var p=d[n].id.indexOf("%")+1;var l=d[n].id.indexOf("Â£");var o=d[n].id.substring(p,l);rData.setWebResultsDate(o)}else{if(navigator.notification){navigator.notification.alert("Please Try Again Later",i,"Offline","Ok")}else{alert("Please Try Again Later")}}});function i(){}$("#closepopupreview").on("click",function(){popupReview.popup();popupReview.popup("close")});$("#closepopupdialog").on("click",function(){popupDialog.popup();popupDialog.popup("close")});$(".ToResend").on("click",function(){var l=txData.connectionState();if(l==false){if(navigator.notification){navigator.notification.alert("Offline Cant Complete Request",i,"Information","Ok")}else{alert("Offline Cant Complete Request")}return}popupDialog.popup("open");var m=$(this).index(".ToResend");$('.ToWeb[data-id="'+m+'"]').css("background-color","LightCoral");var n=setTimeout(function(){txData.sendOfflineData(d[m].id)},1000)});$(".ToClear").on("click",function(){var n=$(this).index(".ToClear");if(navigator.notification){navigator.notification.confirm("Are you sure you want to Delete ?",o,"Notice",["Cancel","Ok"])}else{var m=confirm("Are you sure you want to Delete ?");if(m){$("#popupDialog").popup("open");$.jStorage.deleteKey(d[n].id);var p=setTimeout(function(){$("#popupDialog").popup("close")},2000)}}function o(q){if(q==2){$("#popupDialog").popup("open");$.jStorage.deleteKey(d[n].id);var r=setTimeout(function(){$("#popupDialog").popup();$("#popupDialog").popup("close")},2000)}}function l(){}});$('.ToWeb[data-status="false"]').css("background-color","LightCoral");$('.ToWeb[data-status="true"]').css("background-color","DarkSeaGreen")},txToMongoDB:function(h,o,g,d){var p={};var j=null;var e=null;var c=null;var l=null;var m=null;if(typeof device!="undefined"){j=device.phonegap;e=device.model;c=device.uuid;l=device.platform;m=device.version}$.mobile.showPageLoadingMsg("b","Uploading Data ...");if(j===null){devPgD=new Date();j=devPgD.getHours()+":"+devPgD.getMinutes()+":"+devPgD.getSeconds()}if(e===null){e="Web"}if(c===null){c="unknown"}if(l===null){l="Chrome"}if(m===null){m="unknown"}var b=dataItem.appVers;var n=d;var a=statusItem.baseURL+"/SessionMobileData";var k={athID:o[0].usID,devUUID:"UUID Issue",devName:e,devPhoneGap:j,devPlatform:l,devVersion:m,appVersion:b,upLoadID:o[0].upLoadID,keyID:n,updTime:new Date(),rowDataArr:o};var i=Object.keys(txData).length;var f=statusItem.sendTimeout;jQuery.ajax({url:a,dataType:"json",jsonpCallback:"_rowsage",cache:false,timeout:f,type:"POST",crossDomain:true,async:true,data:k,success:function(r,t,q){var s;if(r.writeResult=="Success"){s=r.upLoadId;keyToUpdate=r.keyID;txData.upDateSavingStatus(keyToUpdate,s,true)}else{s=r.upLoadId;keyToUpdate=r.keyID;txData.upDateSavingStatus(keyToUpdate,s,false)}},error:function(q,s,r){txData.upDateSavingStatus(n,g,false)},complete:function(){$.mobile.hidePageLoadingMsg()}})}};